---
layout: post
section-type: post
title: malloc的过程，学习一下内存分布
category: c
tags: [ "c语言", "基础知识" ]
---
进程虚拟内存分布

**代码段（Code Segment）**存放的是二进制可执行代码。

**堆段（Heap）**自低地址向高地址动态扩展，主要用于动态内存分配。

**栈段（Stack）**则从高地址向低地址收缩，存储局部变量和函数调用上下文信息。

上述各段描述的是进程专属的虚拟内存区域。

---

对于内存分配：

- 当需要分配小于128KB的内存时，通过 `brk` 系统调用从堆中分配，实际分配过程中会尽量利用内存池，以降低系统调用频率和缺页异常的发生，但这种方法可能导致内存碎片问题。（操作系统会根据需要动态分配相应的物理内存，并通过页表机制将虚拟内存映射到物理内存，一旦发生缺页异常（Page Fault），系统将触发页面置换或分配新页面）；
- 当需要分配大于128KB的内存时，则通过 `mmap` 系统调用从文件映射段分配内存。

`malloc` 是 C 语言标准库提供的内存分配函数，虽然它不是一个系统调用，但在用户空间中调用 `malloc` 实际上会通过系统调用来操作外部资源。

对于内存释放：

- 使用 `free` 函数来释放之前通过 `malloc` 分配的内存。`free` 接受一个指向已分配内存区域的指针作为参数。
- 通过 `brk` 从堆中分配的内存，在调用 `free` 后会被归还到内存池中；
- 而通过 `mmap` 分配的内存，在调用 `free` 后会立即归还给操作系统。

此外，`malloc` 在分配内存时通常会额外分配16字节用于存储内存块的大小信息，以便于 `free` 函数正确判断和释放内存。实际上，指向内存块的指针会左偏移16字节来定位内存块的实际内容。
```go
func main(){
fmt.Println("sjs")
}
```